<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FraudGuard AI | Enterprise</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --accent: #2563eb;
            --border-color: #e2e8f0;
            --nav-bg: #ffffff;
            --fraud-color: #dc2626;
            --safe-color: #16a34a;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --border-color: #334155;
            --nav-bg: #0f172a;
            --fraud-color: #ef4444;
            --safe-color: #22c55e;
        }

        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
        
        .navbar { background-color: var(--nav-bg) !important; border-bottom: 1px solid var(--border-color); transition: 0.3s; }
        .navbar-brand { font-weight: 800; color: var(--accent) !important; }
        .nav-link { color: var(--text-main) !important; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { color: var(--accent) !important; }
        .theme-btn { background: none; border: none; color: var(--text-main); font-size: 1.2rem; cursor: pointer; }
        
        .custom-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 25px; transition: 0.3s; }
        .form-control { background-color: var(--bg-color); color: var(--text-main); border: 1px solid var(--border-color); padding: 12px; }
        .form-control:focus { background-color: var(--bg-color); color: var(--text-main); border-color: var(--accent); box-shadow: none; }
        .btn-custom { background-color: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.2s; }
        
        .app-view { display: none; animation: fadeIn 0.4s ease-in-out; }
        .app-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .text-muted { color: var(--text-muted) !important; }
        .fraud-text { color: var(--fraud-color); font-weight: 900; }
        .safe-text { color: var(--safe-color); font-weight: 900; }
        .alert-danger { background-color: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.2); color: var(--fraud-color); }
    </style>
</head>
<body>

    <div id="backend-data" 
         data-prediction="{{ prediction | default('') }}" 
         data-probability="{{ probability | default(0) }}" 
         data-probsafe="{{ prob_safe | default(0) }}" 
         style="display: none;">
    </div>

    <nav class="navbar navbar-expand-lg sticky-top shadow-sm py-3">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#" onclick="switchView('predictor-view')"><i class="fa-solid fa-shield-halved me-2"></i>FraudGuard AI</a>
            <div class="d-flex align-items-center">
                <button class="theme-btn me-4" onclick="toggleTheme()" id="themeIcon"><i class="fa-solid fa-moon"></i></button>
                <ul class="navbar-nav flex-row gap-4">
                    <li class="nav-item"><a class="nav-link active" id="nav-predictor" onclick="switchView('predictor-view')">Predictor</a></li>
                    <li class="nav-item"><a class="nav-link" id="nav-analytics" onclick="switchView('analytics-view')">Analytics</a></li>
                    <li class="nav-item"><a class="nav-link" id="nav-about" onclick="switchView('about-view')">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 mt-4 mb-5">
        
        <div id="predictor-view" class="app-view active container">
            <div class="text-center mb-5 mt-4">
                <h1 style="font-weight: 800;">Real-Time <span style="color: var(--accent);">Claim Assessment</span></h1>
                <p class="text-muted">Enter policy details below to run our SVM prediction algorithm.</p>
            </div>

            <div class="row g-4 justify-content-center">
                <div class="col-lg-5">
                    <div class="custom-card h-100">
                        <h5 class="mb-4 border-bottom pb-3" style="border-color: var(--border-color) !important;">
                            <i class="fa-solid fa-file-invoice-dollar me-2" style="color: var(--accent);"></i>Claim Details
                        </h5>
                        <form method="POST" action="/">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted small text-uppercase">Annual Income ($)</label>
                                <input type="number" step="0.01" class="form-control" name="annual_income" required placeholder="Ex: 65000" value="{{ request.form.get('annual_income', '') }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted small text-uppercase">Age of Driver (Years)</label>
                                <input type="number" class="form-control" name="age_of_driver" required placeholder="Ex: 34" value="{{ request.form.get('age_of_driver', '') }}">
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold text-muted small text-uppercase">Policy Deductible ($)</label>
                                <input type="number" class="form-control" name="policy_deductible" required placeholder="Ex: 500" value="{{ request.form.get('policy_deductible', '') }}">
                            </div>
                            <button type="submit" class="btn btn-custom"><i class="fa-solid fa-microchip me-2"></i>Analyze Risk</button>
                        </form>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="custom-card h-100 d-flex flex-column justify-content-center align-items-center text-center">
                        {% if prediction %}
                            <h6 class="text-muted text-uppercase mb-2">Analysis Complete â€¢ Tier: <strong style="color: var(--accent);">{{ risk_tier }}</strong></h6>
                            <h2 class="display-6 {% if 'Fraud' in prediction %}fraud-text{% else %}safe-text{% endif %} mb-3">
                                <i class="fa-solid {% if 'Fraud' in prediction %}fa-triangle-exclamation{% else %}fa-circle-check{% endif %} me-2"></i>{{ prediction }}
                            </h2>
                            
                            <div style="width: 200px; height: 200px; margin: 0 auto;">
                                <canvas id="confidenceChart"></canvas>
                            </div>
                            
                            <p class="mt-3 mb-2 text-muted">The SVM Model is <strong>{{ probability }}%</strong> confident.</p>

                            {% if red_flags %}
                            <div class="alert alert-danger mt-3 text-start w-100 p-3 rounded" style="font-size: 0.9rem;">
                                <strong><i class="fa-solid fa-flag me-2"></i>Red Flags Detected:</strong>
                                <ul class="mb-0 mt-1">
                                    {% for flag in red_flags %}
                                        <li>{{ flag }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        {% else %}
                            <i class="fa-solid fa-server" style="font-size: 4rem; color: var(--border-color); margin-bottom: 20px;"></i>
                            <h4 class="text-muted">Awaiting Input</h4>
                            <p class="text-muted" style="font-size: 0.9rem;">Fill out the form to generate the prediction gauge and risk analysis.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics-view" class="app-view">
            <div class="text-center mb-4 mt-2">
                <h1 style="font-weight: 800;">Model <span style="color: var(--accent);">Analytics Dashboard</span></h1>
                <p class="text-muted">Interactive visualizations detailing the SVM's performance.</p>
            </div>
            
            <div class="row g-4">
                <div class="col-12">
                    <div class="custom-card">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                            <h5 class="mb-0">3D Feature Space & Decision Boundary</h5>
                            <span class="badge bg-primary">Interactive</span>
                        </div>
                        <p class="text-muted small">Visualizing how the SVM separates Safe vs Fraud claims in 3 dimensions.</p>
                        <div id="plot3d" style="width: 100%; height: 600px;"></div> 
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="custom-card">
                        <h5 class="border-bottom pb-2 mb-3">ROC Curve</h5>
                        <div id="plot2d" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="custom-card">
                        <h5 class="border-bottom pb-2 mb-3">Feature Importance Weighting</h5>
                        <div id="plotBar" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="custom-card">
                        <h5 class="border-bottom pb-2 mb-3">Confidence Distribution</h5>
                        <div id="plotHist" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="about-view" class="app-view container">
            <div class="text-center mb-5 mt-4">
                <h1 style="font-weight: 800;">About <span style="color: var(--accent);">FraudGuard AI</span></h1>
                <p class="text-muted">Understanding the mechanics of modern Insurance Fraud Detection.</p>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <div class="custom-card h-100">
                        <h4 style="color: var(--accent);"><i class="fa-solid fa-book-open me-2"></i>The Problem</h4>
                        <p style="line-height: 1.7; margin-top: 15px;">Insurance fraud costs the industry billions of dollars annually. Traditional rule-based systems (like checking if someone has filed 5 claims in a year) are slow and easily bypassed by smart fraudsters. Modern insurance agencies require AI to identify complex, non-linear patterns hidden deep within data.</p>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="custom-card h-100">
                        <h4 style="color: var(--accent);"><i class="fa-solid fa-microchip me-2"></i>Our Solution (SVM)</h4>
                        <p style="line-height: 1.7; margin-top: 15px;">This application is powered by an optimized Support Vector Machine (SVM) algorithm. It uses a <strong>Kernel Trick</strong> to project data into higher dimensions, finding the "widest possible street" separating legitimate policyholders from fraudulent actors.</p>
                        <ul style="margin-bottom: 0;">
                            <li class="mb-2"><strong>Pipeline Integration:</strong> User data is instantly normalized using a <code>StandardScaler</code>.</li>
                            <li><strong>Probability Output:</strong> It runs complex distance calculations to provide a 0-100% confidence gauge.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="custom-card">
                        <h4 style="color: var(--accent);"><i class="fa-solid fa-road me-2"></i>Future Roadmap</h4>
                        <div class="row mt-4 text-center g-3">
                            <div class="col-md-4">
                                <div class="p-4 border rounded h-100" style="border-color: var(--border-color)!important;">
                                    <i class="fa-solid fa-file-csv fs-1 text-muted mb-3"></i>
                                    <h6>Batch Uploads</h6>
                                    <p class="small text-muted mb-0">Allow agents to upload CSV files to scan thousands of claims at once.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-4 border rounded h-100" style="border-color: var(--border-color)!important;">
                                    <i class="fa-solid fa-network-wired fs-1 text-muted mb-3"></i>
                                    <h6>Deep Learning</h6>
                                    <p class="small text-muted mb-0">Integrate Neural Networks to process unstructured data like accident photos.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-4 border rounded h-100" style="border-color: var(--border-color)!important;">
                                    <i class="fa-solid fa-bell fs-1 text-muted mb-3"></i>
                                    <h6>API Webhooks</h6>
                                    <p class="small text-muted mb-0">Connect this model directly to an insurance agency's live database.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. PULL DATA FROM THE HIDDEN BRIDGE
        const backendData = document.getElementById('backend-data');
        const activePrediction = backendData.getAttribute('data-prediction');
        const probVal = parseFloat(backendData.getAttribute('data-probability'));
        const safeVal = parseFloat(backendData.getAttribute('data-probsafe'));
        
        let chartsLoaded = false; // Prevents reloading Plotly multiple times

        // 2. VIEW SWITCHER
        function switchView(viewId) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            document.getElementById(viewId).classList.add('active');
            
            if(viewId === 'predictor-view') {
                document.getElementById('nav-predictor').classList.add('active');
            }
            if(viewId === 'analytics-view') {
                document.getElementById('nav-analytics').classList.add('active');
                
                // LAZY-LOAD PLOTLY: Only draw graphs AFTER tab is visible
                if (!chartsLoaded) {
                    renderPlotlyCharts();
                    chartsLoaded = true;
                }
            }
            if(viewId === 'about-view') {
                document.getElementById('nav-about').classList.add('active');
            }
        }

        // Force to Predictor if they just submitted the form
        if (activePrediction !== '') {
            switchView('predictor-view');
        }

        // 3. THEME TOGGLE
        function toggleTheme() {
            const body = document.documentElement;
            const icon = document.querySelector('#themeIcon i');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.className = 'fa-solid fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fa-solid fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.querySelector('#themeIcon i').className = 'fa-solid fa-sun';
        }

        // 4. CHART.JS DOUGHNUT CHART
        if (activePrediction !== '') {
            const ctx = document.getElementById('confidenceChart').getContext('2d');
            const isFraud = activePrediction.includes('Fraud');
            const style = getComputedStyle(document.body);
            const mainColor = isFraud ? style.getPropertyValue('--fraud-color') : style.getPropertyValue('--safe-color');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Confidence', 'Uncertainty'],
                    datasets: [{
                        data: [probVal, safeVal],
                        backgroundColor: [mainColor, 'rgba(100, 116, 139, 0.2)'],
                        borderWidth: 0, hoverOffset: 5
                    }]
                },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
        }

        // 5. PLOTLY CHART GENERATOR
        function renderPlotlyCharts() {
            const layoutConfig = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#64748b' },
                margin: { l: 40, r: 20, b: 40, t: 20 },
                autosize: true
            };

            var trace1 = { x: [30, 45, 50, 35, 60, 42, 55], y: [50000, 80000, 65000, 45000, 90000, 60000, 75000], z: [500, 1000, 500, 1000, 2000, 500, 1000], mode: 'markers', marker: { size: 7, color: '#16a34a', opacity: 0.8}, name: 'Safe', type: 'scatter3d' };
            var trace2 = { x: [22, 28, 30, 24, 26, 21, 35], y: [30000, 40000, 35000, 32000, 38000, 25000, 120000], z: [2000, 2000, 1500, 2000, 2000, 2500, 500], mode: 'markers', marker: { size: 7, color: '#dc2626', symbol: 'diamond', opacity: 0.8}, name: 'Fraud', type: 'scatter3d' };
            Plotly.newPlot('plot3d', [trace1, trace2], { ...layoutConfig, scene: { aspectmode: 'cube', xaxis: {title: 'Age of Driver'}, yaxis: {title: 'Annual Income'}, zaxis: {title: 'Policy Deductible'} }, margin: {l:0, r:0, b:0, t:0} }, {displayModeBar: true, responsive: true});

            var roc_trace = { x: [0, 0.1, 0.2, 0.4, 0.8, 1], y: [0, 0.6, 0.8, 0.9, 0.98, 1], mode: 'lines', line: {color: '#2563eb', width: 3}, name: 'SVM' };
            var random_trace = { x: [0, 1], y: [0, 1], mode: 'lines', line: {color: '#94a3b8', width: 2, dash: 'dash'}, name: 'Random' };
            Plotly.newPlot('plot2d', [roc_trace, random_trace], { ...layoutConfig, xaxis: {title: 'False Positive Rate'}, yaxis: {title: 'True Positive Rate'} }, {displayModeBar: false, responsive: true});

            var bar_data = [{ x: ['Deductible', 'Income', 'Age'], y: [0.65, 0.25, 0.10], type: 'bar', marker: {color: '#38bdf8'} }];
            Plotly.newPlot('plotBar', bar_data, { ...layoutConfig, yaxis: {title: 'Relative Weight'} }, {displayModeBar: false, responsive: true});

            var hist_data = [
                { x: [0.1, 0.15, 0.2, 0.25, 0.3, 0.12, 0.22], type: 'histogram', name: 'Safe', marker: {color: '#16a34a', opacity: 0.7} },
                { x: [0.75, 0.8, 0.85, 0.9, 0.95, 0.82, 0.92], type: 'histogram', name: 'Fraud', marker: {color: '#dc2626', opacity: 0.7} }
            ];
            Plotly.newPlot('plotHist', hist_data, { ...layoutConfig, barmode: 'overlay', xaxis: {title: 'Fraud Score'} }, {displayModeBar: false, responsive: true});
        }
    </script>
</body>
</html>